# Using primes to find primes

Not all divisors have to be tried to find prime numbers: only prime divisors. For instance if a number, say 47, is not a multiple of 2, there's no point in trying to divide by 4, (or 3 and 9, or 5 and 25…).

<pre style="color:#000000;background:#F2F2F2;"><span style="color:#669999; font-weight:bold;">\</span> <span style="color:#669999; font-weight:bold;">p-trial.fs   compute primes by trial division algorithm, using prime divisors
</span>
<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">SQUARED</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n -- n² )</span>
    <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#CC6600; font-weight:bold;">*</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">IS-MULTIPLE?</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">m,n -- f )</span>
    <span style="color:#CC6600; font-weight:bold;">MOD</span> <span style="color:#CC6600; font-weight:bold;">0=</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">CREATE</span> <span style="color:#336699; font-weight:bold;">PRIMES</span>
  <span style="color:#800000; font-weight:bold;">2</span> <span style="color:#CC3300; font-weight:bold;">C,</span>   <span style="color:#800000; font-weight:bold;">3</span> <span style="color:#CC3300; font-weight:bold;">C,</span>   <span style="color:#800000; font-weight:bold;">5</span> <span style="color:#CC3300; font-weight:bold;">C,</span>   <span style="color:#800000; font-weight:bold;">7</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">11</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">13</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">17</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">19</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">23</span> <span style="color:#CC3300; font-weight:bold;">C,</span>
 <span style="color:#800000; font-weight:bold;">29</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">31</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">37</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">41</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">43</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">47</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">53</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">59</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">61</span> <span style="color:#CC3300; font-weight:bold;">C,</span>
 <span style="color:#800000; font-weight:bold;">67</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">71</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">73</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">79</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">83</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">89</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#800000; font-weight:bold;">97</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">101</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">103</span> <span style="color:#CC3300; font-weight:bold;">C,</span>
<span style="color:#800000; font-weight:bold;">107</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">109</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">113</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">127</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">131</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">137</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">139</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">149</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">151</span> <span style="color:#CC3300; font-weight:bold;">C,</span>
<span style="color:#800000; font-weight:bold;">157</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">163</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">167</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">173</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">179</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">181</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">191</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">193</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">197</span> <span style="color:#CC3300; font-weight:bold;">C,</span>
<span style="color:#800000; font-weight:bold;">199</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">211</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">223</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">227</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">229</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">233</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">239</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">241</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#800000; font-weight:bold;">251</span> <span style="color:#CC3300; font-weight:bold;">C,</span>

<span style="color:#800000; font-weight:bold;">54</span> <span style="color:#F07F00; font-weight:bold;">CONSTANT</span> <span style="color:#336699; font-weight:bold;">MAX-PRIMES</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">NTH-PRIME</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n -- p )</span>
    <span style="color:#336699; font-weight:bold;">PRIMES</span> <span style="color:#CC6600; font-weight:bold;">+</span> <span style="color:#CC3300; font-weight:bold;">C@</span> <span style="color:#993300; font-weight:bold;">;</span>
</pre>
We create a table of small primes, which can be retrieved by their index from 0 to 53. Then we can use this table in the loop, stopping when we have found a divisor, or when we have tried all primes, or when *p² > n*.

This word can only find primes below 256², which is why it's guarded by an `ASSERT`.
<pre style="color:#000000;background:#F2F2F2;">
<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">IS-PRIME?</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n -- f )</span>
    <span style="color:#3D3D5C; font-weight:bold;">ASSERT(</span> <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#800000; font-weight:bold;">65536</span> <span style="color:#CC6600; font-weight:bold;">&lt;</span> <span style="color:#3D3D5C; font-weight:bold;">)</span>
    <span style="color:#CC6600; font-weight:bold;">TRUE</span> <span style="color:#009999; font-weight:bold;">SWAP</span>
    <span style="color:#336699; font-weight:bold;">MAX-PRIMES</span> <span style="color:#800000; font-weight:bold;">0</span> <span style="color:#993300; font-weight:bold;">DO</span>
        <span style="color:#993300; font-weight:bold;">I</span> <span style="color:#336699; font-weight:bold;">NTH-PRIME</span>
        <span style="color:#009999; font-weight:bold;">2DUP</span> <span style="color:#336699; font-weight:bold;">SQUARED</span> <span style="color:#CC6600; font-weight:bold;">&lt;</span> <span style="color:#993300; font-weight:bold;">IF</span>
            <span style="color:#009999; font-weight:bold;">DROP</span> <span style="color:#993300; font-weight:bold;">LEAVE</span>
        <span style="color:#993300; font-weight:bold;">ELSE</span> <span style="color:#009999; font-weight:bold;">OVER</span> <span style="color:#009999; font-weight:bold;">SWAP</span> <span style="color:#336699; font-weight:bold;">IS-MULTIPLE?</span> <span style="color:#993300; font-weight:bold;">IF</span>
            <span style="color:#009999; font-weight:bold;">NIP</span> <span style="color:#CC6600; font-weight:bold;">FALSE</span> <span style="color:#009999; font-weight:bold;">SWAP</span> <span style="color:#993300; font-weight:bold;">LEAVE</span>
        <span style="color:#993300; font-weight:bold;">THEN</span> <span style="color:#993300; font-weight:bold;">THEN</span>
    <span style="color:#993300; font-weight:bold;">LOOP</span> <span style="color:#009999; font-weight:bold;">DROP</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">.PRIMES</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n -- )</span>
    <span style="color:#800000; font-weight:bold;">2</span> <span style="color:#993300; font-weight:bold;">DO</span> <span style="color:#993300; font-weight:bold;">I</span> <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#336699; font-weight:bold;">IS-PRIME?</span> <span style="color:#993300; font-weight:bold;">IF</span> <span style="color:#CC6600; font-weight:bold;">.</span> <span style="color:#3D3D5C; font-weight:bold;">CR</span> <span style="color:#993300; font-weight:bold;">ELSE</span> <span style="color:#009999; font-weight:bold;">DROP</span> <span style="color:#993300; font-weight:bold;">THEN</span> <span style="color:#993300; font-weight:bold;">LOOP</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">#PRIMES</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n -- t )</span>
    <span style="color:#800000; font-weight:bold;">0</span> <span style="color:#009999; font-weight:bold;">SWAP</span> <span style="color:#800000; font-weight:bold;">2</span> <span style="color:#993300; font-weight:bold;">DO</span> <span style="color:#993300; font-weight:bold;">I</span> <span style="color:#336699; font-weight:bold;">IS-PRIME?</span> <span style="color:#993300; font-weight:bold;">IF</span> <span style="color:#CC6600; font-weight:bold;">1+</span> <span style="color:#993300; font-weight:bold;">THEN</span> <span style="color:#993300; font-weight:bold;">LOOP</span> <span style="color:#993300; font-weight:bold;">;</span>

</pre>
