# An improved sieve program

The sieve program can be optimized for capacity if we consider that:

- except for number 2, all even bits in all positions are zero
- except for number 5, all corresponding bits in all positions are zero

(this line of reasonning is valid for 3, 7, … as well, but leads to a more complicated scheme).

By eliminating the need to store information for multiples of 2 and multiples of 5, we can store information for 20 numbers in a single byte. 

For example bits 0 to 7 at position 1 gives information for numbers 21 to 39 respectively: 01011010

0: 21 is not prime
1: 23 is prime
0: 27 is not prime
1: 29 is prime
1: 31 is prime
0: 33 is not prime
1: 37 is prime
0: 39 is not prime

To find if number *n* is prime, we first ask if *n* is even : if it's the case then it's either 2 or a non-prime.
If it's not even, is it a multiple of 5 ? It it's the case it's 5 or a non-prime.
We lookup position *n/20* in the sieve, and calculate the bitmask corresponding to *n%20* (that number is either 1,3,7,9,11,13,17 or 19), which allow us to get the information for this number.

For instance, with *n* = 4807, we examine position 240 and find 01100001, meaning that only 4801, 4813 and 4817 are prime numbers, while 4803, 4807, 4807, 4811 and 4819 are not. The bit number for *n%20* is bit #2, and it is zero, so 4807 is not prime.

For a quick mapping between *n%20* and the corresponding bit mask, we initialize a table of bitmasks where only positions 1,3,7,9,11,13,17 and 19 are significant. The other positions are not to be searched, since we eliminates multiples of 2 and multiples of 5 in our search.


<pre style="color:#000000;background:#F2F2F2;"><span style="color:#669999; font-weight:bold;">\</span> <span style="color:#669999; font-weight:bold;">p-sieve.fs compute primes with a sieve
</span>
<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">SQUARED</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n -- n² )</span>
    <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#CC6600; font-weight:bold;">*</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">MULTIPLE</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n,m -- f )</span>
    <span style="color:#CC6600; font-weight:bold;">MOD</span> <span style="color:#CC6600; font-weight:bold;">0=</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">NOR</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">f,g -- ! [f or g] )</span>
    <span style="color:#CC6600; font-weight:bold;">OR</span> <span style="color:#CC6600; font-weight:bold;">0=</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">REVERSE</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">b -- b )</span>
    <span style="color:#800000; font-weight:bold;">255</span> <span style="color:#CC6600; font-weight:bold;">XOR</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#800000; font-weight:bold;">1000</span> <span style="color:#F07F00; font-weight:bold;">CONSTANT</span> <span style="color:#336699; font-weight:bold;">PRIMES-LIMIT</span>
<span style="color:#F07F00; font-weight:bold;">CREATE</span> <span style="color:#336699; font-weight:bold;">PRIMES</span>
  <span style="color:#800000; font-weight:bold;">2</span> <span style="color:#CC3300; font-weight:bold;">,</span>   <span style="color:#800000; font-weight:bold;">3</span> <span style="color:#CC3300; font-weight:bold;">,</span>   <span style="color:#800000; font-weight:bold;">5</span> <span style="color:#CC3300; font-weight:bold;">,</span>   <span style="color:#800000; font-weight:bold;">7</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">11</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">13</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">17</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">19</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">23</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">29</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">31</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">37</span> <span style="color:#CC3300; font-weight:bold;">,</span>
 <span style="color:#800000; font-weight:bold;">41</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">43</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">47</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">53</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">59</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">61</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">67</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">71</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">73</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">79</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">83</span> <span style="color:#CC3300; font-weight:bold;">,</span>  <span style="color:#800000; font-weight:bold;">89</span> <span style="color:#CC3300; font-weight:bold;">,</span>
 <span style="color:#800000; font-weight:bold;">97</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">101</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">103</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">107</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">109</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">113</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">127</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">131</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">137</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">139</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">149</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">151</span> <span style="color:#CC3300; font-weight:bold;">,</span>
<span style="color:#800000; font-weight:bold;">157</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">163</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">167</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">173</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">179</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">181</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">191</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">193</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">197</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">199</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">211</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">223</span> <span style="color:#CC3300; font-weight:bold;">,</span>
<span style="color:#800000; font-weight:bold;">227</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">229</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">233</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">239</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">241</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">251</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">257</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">263</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">269</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">271</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">277</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">281</span> <span style="color:#CC3300; font-weight:bold;">,</span>
<span style="color:#800000; font-weight:bold;">283</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">293</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">307</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">311</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">313</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">317</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">331</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">337</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">347</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">349</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">353</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">359</span> <span style="color:#CC3300; font-weight:bold;">,</span>
<span style="color:#800000; font-weight:bold;">367</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">373</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">379</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">383</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">389</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">397</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">401</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">409</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">419</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">421</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">431</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">433</span> <span style="color:#CC3300; font-weight:bold;">,</span>
<span style="color:#800000; font-weight:bold;">439</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">443</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">449</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">457</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">461</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">463</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">467</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">479</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">487</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">491</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">499</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">503</span> <span style="color:#CC3300; font-weight:bold;">,</span>
<span style="color:#800000; font-weight:bold;">509</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">521</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">523</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">541</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">547</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">557</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">563</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">569</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">571</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">577</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">587</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">593</span> <span style="color:#CC3300; font-weight:bold;">,</span>
<span style="color:#800000; font-weight:bold;">599</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">601</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">607</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">613</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">617</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">619</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">631</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">641</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">643</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">647</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">653</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">659</span> <span style="color:#CC3300; font-weight:bold;">,</span>
<span style="color:#800000; font-weight:bold;">661</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">673</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">677</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">683</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">691</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">701</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">709</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">719</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">727</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">733</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">739</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">743</span> <span style="color:#CC3300; font-weight:bold;">,</span>
<span style="color:#800000; font-weight:bold;">751</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">757</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">761</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">769</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">773</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">787</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">797</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">809</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">811</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">821</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">823</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">827</span> <span style="color:#CC3300; font-weight:bold;">,</span>
<span style="color:#800000; font-weight:bold;">829</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">839</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">853</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">857</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">859</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">863</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">877</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">881</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">883</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">887</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">907</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">911</span> <span style="color:#CC3300; font-weight:bold;">,</span>
<span style="color:#800000; font-weight:bold;">919</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">929</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">937</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">941</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">947</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">953</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">967</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">971</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">977</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">983</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">991</span> <span style="color:#CC3300; font-weight:bold;">,</span> <span style="color:#800000; font-weight:bold;">997</span> <span style="color:#CC3300; font-weight:bold;">,</span>

<span style="color:#800000; font-weight:bold;">168</span> <span style="color:#F07F00; font-weight:bold;">CONSTANT</span> <span style="color:#336699; font-weight:bold;">MAX-PRIMES</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">NTH-PRIME</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n -- p )</span>
    <span style="color:#CC3300; font-weight:bold;">CELLS</span> <span style="color:#336699; font-weight:bold;">PRIMES</span> <span style="color:#CC6600; font-weight:bold;">+</span> <span style="color:#CC3300; font-weight:bold;">@</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#336699; font-weight:bold;">PRIMES-LIMIT</span> <span style="color:#336699; font-weight:bold;">SQUARED</span> <span style="color:#F07F00; font-weight:bold;">CONSTANT</span> <span style="color:#336699; font-weight:bold;">SIEVE-LIMIT</span>
<span style="color:#800000; font-weight:bold;">20</span> <span style="color:#F07F00; font-weight:bold;">CONSTANT</span> <span style="color:#336699; font-weight:bold;">FLAGS/BYTE</span>

<span style="color:#336699; font-weight:bold;">SIEVE-LIMIT</span> <span style="color:#336699; font-weight:bold;">FLAGS/BYTE</span> <span style="color:#CC6600; font-weight:bold;">/</span> <span style="color:#F07F00; font-weight:bold;">CONSTANT</span> <span style="color:#336699; font-weight:bold;">SIEVE-SIZE</span>

<span style="color:#F07F00; font-weight:bold;">CREATE</span> <span style="color:#336699; font-weight:bold;">SIEVE</span> <span style="color:#336699; font-weight:bold;">SIEVE-SIZE</span> <span style="color:#CC3300; font-weight:bold;">ALLOT</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">,,</span>
    <span style="color:#800000; font-weight:bold;">0</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">CREATE</span> <span style="color:#336699; font-weight:bold;">SIEVE-MASKS</span>

<span style="color:#669999; font-weight:bold;">\</span> <span style="color:#669999; font-weight:bold;">   1       3              7       9
</span>  <span style="color:#336699; font-weight:bold;">,,</span> <span style="color:#800000; font-weight:bold;">1</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#336699; font-weight:bold;">,,</span> <span style="color:#800000; font-weight:bold;">2</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#336699; font-weight:bold;">,,</span> <span style="color:#336699; font-weight:bold;">,,</span> <span style="color:#336699; font-weight:bold;">,,</span>  <span style="color:#800000; font-weight:bold;">4</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#336699; font-weight:bold;">,,</span> <span style="color:#800000; font-weight:bold;">8</span> <span style="color:#CC3300; font-weight:bold;">C,</span>

<span style="color:#669999; font-weight:bold;">\</span> <span style="color:#669999; font-weight:bold;">  11       13             17         19
</span><span style="color:#336699; font-weight:bold;">,,</span> <span style="color:#800000; font-weight:bold;">16</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#336699; font-weight:bold;">,,</span> <span style="color:#800000; font-weight:bold;">32</span> <span style="color:#CC3300; font-weight:bold;">C,</span> <span style="color:#336699; font-weight:bold;">,,</span> <span style="color:#336699; font-weight:bold;">,,</span> <span style="color:#336699; font-weight:bold;">,,</span> <span style="color:#800000; font-weight:bold;">64</span> <span style="color:#CC3300; font-weight:bold;">C,</span>  <span style="color:#336699; font-weight:bold;">,,</span> <span style="color:#800000; font-weight:bold;">128</span> <span style="color:#CC3300; font-weight:bold;">C,</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">SIEVE-POS</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n -- addr )</span>
    <span style="color:#336699; font-weight:bold;">FLAGS/BYTE</span> <span style="color:#CC6600; font-weight:bold;">/</span> <span style="color:#336699; font-weight:bold;">SIEVE</span> <span style="color:#CC6600; font-weight:bold;">+</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">SIEVE-MASK</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n -- bitmask )</span>
    <span style="color:#336699; font-weight:bold;">FLAGS/BYTE</span> <span style="color:#CC6600; font-weight:bold;">MOD</span> <span style="color:#336699; font-weight:bold;">SIEVE-MASKS</span> <span style="color:#CC6600; font-weight:bold;">+</span> <span style="color:#CC3300; font-weight:bold;">C@</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">SIEVE!</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n -- )</span>
    <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#800000; font-weight:bold;">2</span> <span style="color:#336699; font-weight:bold;">MULTIPLE</span> <span style="color:#009999; font-weight:bold;">OVER</span> <span style="color:#800000; font-weight:bold;">5</span> <span style="color:#336699; font-weight:bold;">MULTIPLE</span> <span style="color:#336699; font-weight:bold;">NOR</span> <span style="color:#993300; font-weight:bold;">IF</span>
        <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#336699; font-weight:bold;">SIEVE-MASK</span> <span style="color:#336699; font-weight:bold;">REVERSE</span>
        <span style="color:#009999; font-weight:bold;">SWAP</span> <span style="color:#336699; font-weight:bold;">SIEVE-POS</span>
        <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#CC3300; font-weight:bold;">C@</span> <span style="color:#009999; font-weight:bold;">ROT</span> <span style="color:#CC6600; font-weight:bold;">AND</span> <span style="color:#009999; font-weight:bold;">SWAP</span> <span style="color:#CC3300; font-weight:bold;">C!</span>
    <span style="color:#993300; font-weight:bold;">ELSE</span> <span style="color:#009999; font-weight:bold;">DROP</span> <span style="color:#993300; font-weight:bold;">THEN</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">INIT-SIEVE</span>
    <span style="color:#336699; font-weight:bold;">SIEVE</span> <span style="color:#336699; font-weight:bold;">SIEVE-SIZE</span> <span style="color:#800000; font-weight:bold;">255</span> <span style="color:#CC3300; font-weight:bold;">FILL</span>
    <span style="color:#800000; font-weight:bold;">1</span> <span style="color:#336699; font-weight:bold;">SIEVE!</span>
    <span style="color:#336699; font-weight:bold;">MAX-PRIMES</span> <span style="color:#800000; font-weight:bold;">1</span> <span style="color:#993300; font-weight:bold;">DO</span>
        <span style="color:#993300; font-weight:bold;">I</span> <span style="color:#336699; font-weight:bold;">NTH-PRIME</span> <span style="color:#009999; font-weight:bold;">DUP</span>
        <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#336699; font-weight:bold;">SQUARED</span>
        <span style="color:#993300; font-weight:bold;">BEGIN</span>
            <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#336699; font-weight:bold;">SIEVE-LIMIT</span> <span style="color:#CC6600; font-weight:bold;">&lt;</span> <span style="color:#993300; font-weight:bold;">WHILE</span>
            <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#336699; font-weight:bold;">SIEVE!</span>
            <span style="color:#009999; font-weight:bold;">OVER</span> <span style="color:#CC6600; font-weight:bold;">+</span>
        <span style="color:#993300; font-weight:bold;">REPEAT</span>
        <span style="color:#009999; font-weight:bold;">2DROP</span> <span style="color:#009999; font-weight:bold;">DROP</span>
    <span style="color:#993300; font-weight:bold;">LOOP</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#336699; font-weight:bold;">INIT-SIEVE</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">IS-PRIME?</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">n -- f )</span>
    <span style="color:#3D3D5C; font-weight:bold;">ASSERT(</span> <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#336699; font-weight:bold;">SIEVE-LIMIT</span> <span style="color:#CC6600; font-weight:bold;">&lt;</span> <span style="color:#3D3D5C; font-weight:bold;">)</span>
    <span style="color:#3D3D5C; font-weight:bold;">ASSERT(</span> <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#800000; font-weight:bold;">1</span> <span style="color:#CC6600; font-weight:bold;">&gt;</span> <span style="color:#3D3D5C; font-weight:bold;">)</span>
    <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#800000; font-weight:bold;">2</span> <span style="color:#336699; font-weight:bold;">MULTIPLE</span> <span style="color:#993300; font-weight:bold;">IF</span> <span style="color:#800000; font-weight:bold;">2</span> <span style="color:#CC6600; font-weight:bold;">=</span>
    <span style="color:#993300; font-weight:bold;">ELSE</span>
        <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#800000; font-weight:bold;">5</span> <span style="color:#336699; font-weight:bold;">MULTIPLE</span> <span style="color:#993300; font-weight:bold;">IF</span> <span style="color:#800000; font-weight:bold;">5</span> <span style="color:#CC6600; font-weight:bold;">=</span>
    <span style="color:#993300; font-weight:bold;">ELSE</span>
        <span style="color:#009999; font-weight:bold;">DUP</span> <span style="color:#336699; font-weight:bold;">SIEVE-MASK</span> <span style="color:#009999; font-weight:bold;">SWAP</span>
        <span style="color:#336699; font-weight:bold;">SIEVE-POS</span> <span style="color:#CC3300; font-weight:bold;">C@</span> <span style="color:#009999; font-weight:bold;">SWAP</span> <span style="color:#CC6600; font-weight:bold;">AND</span>
    <span style="color:#993300; font-weight:bold;">THEN</span> <span style="color:#993300; font-weight:bold;">THEN</span> <span style="color:#993300; font-weight:bold;">;</span>

<span style="color:#F07F00; font-weight:bold;">:</span> <span style="color:#336699; font-weight:bold;">.PRIMES</span> <span style="color:#669999; font-weight:bold;">(</span> <span style="color:#669999; font-weight:bold;">m,n -- )</span>
    <span style="color:#009999; font-weight:bold;">SWAP</span> <span style="color:#993300; font-weight:bold;">DO</span> <span style="color:#993300; font-weight:bold;">I</span> <span style="color:#336699; font-weight:bold;">IS-PRIME?</span> <span style="color:#993300; font-weight:bold;">IF</span> <span style="color:#993300; font-weight:bold;">I</span> <span style="color:#CC6600; font-weight:bold;">.</span> <span style="color:#3D3D5C; font-weight:bold;">CR</span> <span style="color:#993300; font-weight:bold;">THEN</span> <span style="color:#993300; font-weight:bold;">LOOP</span> <span style="color:#993300; font-weight:bold;">;</span>

</pre>
If we know primes in the range *2* to *p*, then we can find all composites from *p* to *p²* as shown in the `sieve.fs` program, where *p* = 251.


suppose we know only 2,3,5,7, then if n=6, we can have a sieve from 10 to 59, where numbers 10,12,14,16,18,…,58,15,21,27,33,39,45,51,57,25,35,55,49 are marked as composite leaving 11,13,17,19,23,29,31,37,41,43,47,53 as primes.

to find the starting point 



